name: ci-workflows

on:
  page_build: {}
  workflow_dispatch: {}
  # schedule:
  #   - cron: "0 0 * * 0" // every Sunday at midnight

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    if: "! contains(github.event.head_commit.message, 'in CI')"

    steps:
      - name: "Download gh-trs binary from artifact"
        id: download-binary-artifact
        run: |
          RUN_ID=`gh run --repo suecharo/gh-trs list --workflow build_binary --json databaseId --jq .[0].databaseId`
          gh run --repo suecharo/gh-trs download ${RUN_ID} -n gh-trs
          chmod +x gh-trs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: "Download gh-trs binary from release"
        if: ${{ steps.download-binary-artifact.outcome != 'success' }}
        run: |
          curl -fsSL -O https://github.com/suecharo/gh-trs/releases/latest/download/gh-trs
          chmod +x ./gh-trs

      - name: "Run tests and publish"
        id: test-and-publish
        run: |
          mkdir -p ./test-logs
          SAPPORO_RUN_DIR=${GITHUB_WORKSPACE}/test-results ./gh-trs publish --verbose --with-test --repo suecharo/gh-trs --branch gh-pages --from-trs https://suecharo.github.io/gh-trs/ 2>&1 | tee ./test-logs/gh-trs.log
          exit ${PIPESTATUS[0]}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "List test results"
        run: ls -lR ./test-results > ./test-logs/results-list.txt

      - name: "Upload test logs"
        uses: actions/upload-artifact@v2
        with:
          name: gh-trs-test-logs
          path: test-logs/*
          if-no-files-found: ignore

      - name: "Check test status"
        if: ${{ steps.test.outcome != 'success' }}
        run: exit 1
